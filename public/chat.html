
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>チャットルーム</title>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>チャットルーム</h1>
    <p>ログインユーザー: <span id="displayUsername"></span></p>

    <h2>入りたい部屋をクリックしてください</h2>
    <button onclick="joinRoom('room1')">雑談部屋</button>
    <button onclick="joinRoom('room2')">雑談部屋2</button>

    <h3 id="roomTitle"></h3>

    <div id="chat"></div>

    <input type="text" id="messageInput" placeholder="メッセージを入力..." />
    <button onclick="sendMessage()">送信</button>
    <br><br>

    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">ファイル送信</button>

    <h3>ユーザー一覧（DM）</h3>
    <ul id="userList"></ul>

    <script>
        const socket = io();
        let currentRoom = "";
        const username = localStorage.getItem("username") || "Guest";
        document.getElementById("displayUsername").textContent = username;

        function joinRoom(room) {
            currentRoom = room;
            document.getElementById("roomTitle").textContent = `チャットルーム: ${room}`;
            document.getElementById("chat").innerHTML = "";
            socket.emit("joinRoom", { room, username });
        }

        function sendMessage() {
            const text = document.getElementById("messageInput").value;
            fetch("/send-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: text, username, room: currentRoom })
            });
            document.getElementById("messageInput").value = "";
        }

        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return alert("ファイルを選択してください");

            const formData = new FormData();
            formData.append("file", file);
            formData.append("username", username);
            formData.append("room", currentRoom);

            fetch("/upload", {
                method: "POST",
                body: formData
            });
        }

        socket.on("message", (data) => {
            const div = document.createElement("div");
            if (data.text) {
                div.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
            } else if (data.file) {
                div.innerHTML = `<strong>${data.user}:</strong> <a href="${data.file}" target="_blank">ファイルを見る</a>`;
            }
            document.getElementById("chat").appendChild(div);
        });

        socket.on("messageHistory", (messages) => {
            messages.forEach(data => socket.emit("message", data));
        });

        socket.on("userList", (users) => {
            const userList = document.getElementById("userList");
            userList.innerHTML = "";
            users.forEach(user => {
                const li = document.createElement("li");
                li.textContent = user;
                userList.appendChild(li);
            });
        });

        socket.on("updatePinnedMessage", ({ message }) => {
            const pinned = document.getElementById("pinned");
            if (pinned) {
                pinned.textContent = `📌 ピン止め: ${message}`;
            } else {
                const p = document.createElement("p");
                p.id = "pinned";
                p.textContent = `📌 ピン止め: ${message}`;
                document.body.insertBefore(p, document.getElementById("chat"));
            }
        });
    </script>
</body>
</html>
