<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>チャットルーム</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #chatContainer { border: 2px solid #000; padding: 10px; width: 400px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>チャットルーム</h1>

    <div id="chatContainer">
        <p id="usernameDisplay"></p> 
        <select id="roomSelect">
            <option value="雑談部屋">雑談部屋（下ネタ・暴言禁止）</option>
            <option value="雑談部屋2">雑談部屋2（下ネタ・暴言OK）</option>
            <option value="PC特化部屋">PC特化部屋</option>
        </select>
        <button onclick="joinRoom()">部屋に入る</button>
        <button onclick="logout()">ログアウト</button>
        <div id="messages"></div>
        <input id="messageInput" type="text" placeholder="メッセージを入力..." />
        <button onclick="sendMessage()">送信</button>
        <input id="fileInput" type="file" />
        <button onclick="sendFile()">画像・動画を送信</button>
    </div>

    <script>
        if (localStorage.getItem("authenticated") !== "true") {
            window.location.href = "index.html";
        }

        const socket = io();
        const username = localStorage.getItem("username") || "ゲスト";
        let currentRoom = "雑談部屋";

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("usernameDisplay").textContent = `ログインユーザー: ${username}`;
            socket.emit("joinRoom", currentRoom);
        });

        socket.on('messageHistory', (history) => {
            document.getElementById('messages').innerHTML = "";
            history.forEach((data) => {
                if (data.username && data.message) {
                    addMessageToChat(data);
                } else if (data.data) {
                    displayFile(data);
                }
            });
        });

        socket.on('message', (data) => {
            addMessageToChat(data);
        });

        socket.on('file', (file) => {
            displayFile(file);
        });

        function joinRoom() {
            currentRoom = document.getElementById("roomSelect").value;
            console.log(`🔹 部屋選択: ${currentRoom}`);
            socket.emit("joinRoom", currentRoom);
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message.trim()) return;
            const data = { username, message, room: currentRoom };
            socket.emit('message', data);
        }

        function sendFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                const fileData = { username, data: reader.result, room: currentRoom };
                socket.emit('file', fileData);
            };
            reader.readAsDataURL(file);
        }

        function addMessageToChat(data) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${data.username}</strong>: ${data.message}`;
            document.getElementById('messages').appendChild(div);
        }

        function displayFile(file) {
            if (!file.data) return;
            const container = document.createElement('div');
            const button = document.createElement('button');
            button.textContent = "画像を表示する";
            button.onclick = () => {
                image.classList.toggle('hidden');
            };
            const image = document.createElement(file.data.startsWith("data:image") ? 'img' : 'video');
            image.src = file.data;
            image.controls = file.data.startsWith("data:video");
            image.classList.add('hidden');
            image.style.maxWidth = "100%";
            container.appendChild(button);
            container.appendChild(image);
            document.getElementById('messages').appendChild(container);
        }

        function logout() {
            localStorage.removeItem("authenticated");
            localStorage.removeItem("username");
            window.location.href = "index.html";
        }
    </script>
</body>
</html>


